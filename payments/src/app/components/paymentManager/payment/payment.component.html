<div class="payment-page">
  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
  </div>
  
  <div *ngIf="loading" class="loading-spinner">
    Loading...
  </div>
  
  <div class="summary-cards">
    <div class="card light-blue">
      <h2>{{ totalPayments }}</h2>
      <p>Total Payments</p>
    </div>
    <div class="card light-yellow">
      <h2>LKR {{ totalAmount | number }}</h2>
      <p>Total Amount Paid</p>
    </div>
  </div>
  
  <div class="payment-methods">
    <div class="method-card">
      <h3>Cash</h3>
      <p>LKR {{ paymentsByCash | number }}</p>
    </div>
    <div class="method-card">
      <h3>Bank Transfer</h3>
      <p>LKR {{ paymentsByBank | number }}</p>
    </div>
    <div class="method-card">
      <h3>Cheque</h3>
      <p>LKR {{ paymentsByCheque | number }}</p>
    </div>
  </div>
  
  <div class="payment-container">
    <h3>Supplier Payments</h3>
    
    <div class="manual-entry">
      <h4>Create New Payment</h4>
      
      <div class="calculator-toggle">
        <button (click)="toggleCalculator()" class="calculator-btn">
          {{ showCalculator ? 'Hide Calculator' : 'Use Payment Calculator' }}
        </button>
      </div>
      
      <!-- <div *ngIf="showCalculator" class="calculator-container">
        <app-payment-calculator 
          [suppliers]="suppliers"
          [initialSupplierId]="paymentForm.get('SupplierId')?.value"
          [initialLeafWeight]="paymentForm.get('leafWeight')?.value"
          [initialRate]="paymentForm.get('rate')?.value"
          (calculationComplete)="onCalculationComplete($event)">
        </app-payment-calculator>
      </div> -->
      
      <form [formGroup]="paymentForm" (ngSubmit)="createPayment()">
        <div class="form-grid">
          <div class="form-group">
            <label>Supplier:</label>
            <select formControlName="SupplierId">
              <option value="">Select Supplier</option>
              <option *ngFor="let supplier of suppliers" [value]="supplier.SupplierId">
                {{ supplier.SupplierId }} - {{ supplier.Name }}
              </option>
            </select>
            <div *ngIf="paymentForm.get('SupplierId')?.touched && paymentForm.get('SupplierId')?.invalid" class="error-message">
              Supplier is required
            </div>
          </div>
          
          <div class="form-group">
            <label>Green Leaf Weight (kg):</label>
            <input type="number" formControlName="leafWeight" placeholder="Auto-loaded from supplier">
            <div *ngIf="paymentForm.get('leafWeight')?.touched && paymentForm.get('leafWeight')?.invalid" class="error-message">
              Valid weight is required
            </div>
          </div>
          
          <div class="form-group">
            <label>Rate per kg (LKR):</label>
            <input type="number" formControlName="rate" placeholder="Enter rate">
            <div *ngIf="paymentForm.get('rate')?.touched && paymentForm.get('rate')?.invalid" class="error-message">
              Valid rate is required
            </div>
          </div>
          
          <div class="form-group">
            <label>Gross Amount (LKR):</label>
            <input type="number" formControlName="grossAmount" readonly>
          </div>
          
          <div class="form-group">
            <label>Advance Deduction (LKR):</label>
            <input type="number" formControlName="advanceDeduction">
          </div>
          
          <div class="form-group">
            <label>Debt Deduction (LKR):</label>
            <input type="number" formControlName="debtDeduction">
          </div>
          
          <div class="form-group">
            <label>Incentive Addition (LKR):</label>
            <input type="number" formControlName="incentiveAddition">
          </div>
          
          <div class="form-group">
            <label>Net Amount (LKR):</label>
            <input type="number" formControlName="netAmount" readonly>
          </div>
          
          <div class="form-group">
            <label>Payment Method:</label>
            <select formControlName="paymentMethod">
              <option value="Cash">Cash</option>
              <option value="Bank Transfer">Bank Transfer</option>
              <option value="Cheque">Cheque</option>
            </select>
            <div *ngIf="paymentForm.get('paymentMethod')?.touched && paymentForm.get('paymentMethod')?.invalid" class="error-message">
              Payment method is required
            </div>
          </div>
          
          <div class="form-group">
            <label>Payment Date:</label>
            <input type="date" formControlName="paymentDate">
            <div *ngIf="paymentForm.get('paymentDate')?.touched && paymentForm.get('paymentDate')?.invalid" class="error-message">
              Valid date is required
            </div>
          </div>
          
          <div class="form-group">
            <button type="submit" class="create-btn" [disabled]="loading">
              {{ loading ? 'Creating...' : 'Create Payment' }}
            </button>
          </div>
        </div>
      </form>
    </div>
    
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Payment ID</th>
            <th>Supplier ID</th>
            <th>Leaf Weight</th>
            <th>Rate</th>
            <th>Gross Amount</th>
            <th>Deductions</th>
            <th>Incentives</th>
            <th>Net Amount</th>
            <th>Method</th>
            <th>Payment Date</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngIf="filteredPayments && filteredPayments.length > 0; else noPayments">
            <tr *ngFor="let payment of filteredPayments">
              <td>{{ payment.PaymentId }}</td>
              <td>{{ payment.SupplierId }}</td>
              <td>{{ payment.LeafWeight }} kg</td>
              <td>LKR {{ payment.Rate | number }}</td>
              <td>LKR {{ payment.GrossAmount | number }}</td>
              <td>LKR {{ ((payment.AdvanceDeduction || 0) + (payment.DebtDeduction || 0)) | number }}</td>
              <td>LKR {{ (payment.IncentiveAddition || 0) | number }}</td>
              <td>LKR {{ payment.NetAmount | number }}</td>
              <td>{{ payment.PaymentMethod }}</td>
              <td>{{ payment.PaymentDate | date:'short' }}</td>
            </tr>
          </ng-container>
          <ng-template #noPayments>
            <tr>
              <td colspan="10" class="no-data">
                No payments found. 
                <span *ngIf="error" class="error-text">Error: {{ error }}</span>
              </td>
            </tr>
          </ng-template>
        </tbody>
      </table>
    </div>
  </div>
</div>
