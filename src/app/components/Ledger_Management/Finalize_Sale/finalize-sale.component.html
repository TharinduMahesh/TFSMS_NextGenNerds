<!-- src/app/components/Ledger_Management/Finalize_Sale/finalize-sale.component.html -->

<div class="claims-entry-container"> <!-- Reusing general container class for consistent styling -->
  <h1 class="page-title">Finalize Sale</h1>

  <div class="form-section">
    <h2>Finalizing Sale for Invoice</h2>
    <div class="form-fields-grid">
      <!-- Display details of the selected Invoice -->
      <div class="form-group display-group">
        <label>Invoice #:</label>
        <p>{{ selectedInvoice?.invoiceNumber || 'N/A' }}</p>
      </div>
      <div class="form-group display-group">
        <label>Broker:</label>
        <p>{{ selectedInvoice?.brokerName || 'N/A' }}</p>
      </div>
      <div class="form-group display-group">
        <label>Weight (Kg):</label>
        <!-- FIX: Use *ngIf with local variable 'stockEntry' for clarity and to remove || 'N/A' -->
        <p>
          <ng-container *ngIf="selectedInvoice?.stockLedgerEntry as stockEntry; else noWeight">
            {{ stockEntry.currentWeightKg | number:'1.2-2' }}
          </ng-container>
          <ng-template #noWeight>N/A</ng-template>
        </p>
      </div>
    </div>
  </div>

  <div class="form-section">
    <h2>Enter Final Buyer and Price Details</h2>
    <form (ngSubmit)="finalizeSale()">
      <div class="form-fields-grid">
        <div class="form-group">
          <label for="buyerName">Buyer Name:</label>
          <input type="text" id="buyerName" [(ngModel)]="buyerName" name="buyerName" placeholder="e.g., Global Tea Buyers" required>
        </div>
        <div class="form-group">
          <label for="finalSoldPricePerKg">Sold Price per Kg (LKR):</label>
          <input type="number" id="finalSoldPricePerKg" [(ngModel)]="finalSoldPricePerKg" (input)="calculateFinalTotalAmount()" name="finalSoldPricePerKg" placeholder="e.g., 950.00" step="0.01" required min="0">
        </div>
        <div class="form-group">
          <label for="finalTotalAmount">Total Amount (LKR):</label>
          <input type="number" id="finalTotalAmount" [(ngModel)]="finalTotalAmount" name="finalTotalAmount" placeholder="Calculated automatically" readonly>
        </div>
      </div>

      <!-- Sales Charges Section (Existing and New) -->
      <div class="sales-charges-section">
        <h3>Sales Charges</h3>
        <!-- Display Existing Sales Charges -->
        <div *ngIf="salesCharges.length > 0" class="sales-charges-list">
          <h4>Current Charges:</h4>
          <ul>
            <li *ngFor="let charge of salesCharges; let i = index">
              {{ charge.chargeType }}: {{ charge.amount | number:'1.2-2' }} LKR
              <button type="button" class="remove-charge-btn" (click)="removeSalesCharge(i)">X</button>
            </li>
          </ul>
        </div>

        <h4>Add New Charge:</h4>
        <div class="sales-charge-form-grid">
          <div class="form-group">
            <label for="newChargeType">Charge Type:</label>
            <input type="text" id="newChargeType" [(ngModel)]="newChargeType" name="newChargeType" placeholder="e.g., Commission">
          </div>
          <div class="form-group">
            <label for="newChargeAmount">Amount:</label>
            <input type="number" id="newChargeAmount" [(ngModel)]="newChargeAmount" name="newChargeAmount" placeholder="e.g., 1500.00" step="0.01" min="0">
          </div>
          <div class="form-group full-width">
            <label for="newChargeDescription">Description (Optional):</label>
            <textarea id="newChargeDescription" [(ngModel)]="newChargeDescription" name="newChargeDescription" rows="2" placeholder="Details of the charge"></textarea>
          </div>
          <div class="form-actions add-charge-action">
            <button type="button" class="action-button secondary-button" (click)="addSalesCharge()">+ Add Charge</button>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button class="action-button secondary-button" type="button" (click)="exitPage()">Back to Invoices</button>
        <button class="action-button primary-button" type="submit">Finalize Sale</button>
      </div>
    </form>
  </div>
</div>

<!-- FIX: Define ng-template for noWeight outside the <td> -->
<ng-template #noWeight>N/A</ng-template>
