<!-- This is the Modal Wrapper -->
<div class="modal-overlay visible">
  <div class="modal-content visible">
    <!-- THE FIX IS HERE: Changed onClose() to the existing onCancel() -->
    <button (click)="onCancel()" class="close-btn" title="Close">Ã—</button>

    <!-- Your Component's Content Starts Here -->
    <div class="page-container">
    
      @if (isLoading()) {
        <div class="loading">Loading route data...</div>
      } @else if (error()) {
        <div class="error">{{ error() }}</div>
      } @else {
        <div class="page-wrapper">
          <h2 class="modal-title orange">Edit Route</h2>
          <div class="modal-body">
            <form [formGroup]="routeForm" (ngSubmit)="onSubmit()" class="form-wrapper">
              <fieldset class="form-section orange">
                <legend>Route Details</legend>
                <div class="form-group">
                  <label for="edit-rName">Route Name</label>
                  <input id="edit-rName" type="text" formControlName="rName" placeholder="e.g., Kandy City Morning Run" />
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="edit-startLocation">Start Location</label>
                    <input id="edit-startLocation" type="text" formControlName="startLocation" placeholder="e.g., Main Factory" />
                  </div>
                  <div class="form-group">
                    <label for="edit-endLocation">End Location</label>
                    <input id="edit-endLocation" type="text" formControlName="endLocation" placeholder="e.g., Peradeniya Junction" />
                  </div>
                </div>
                <div class="form-group">
                  <label for="edit-distance">Distance (km)</label>
                  <input id="edit-distance" type="number" formControlName="distance" placeholder="e.g., 25" />
                </div>
              </fieldset>
              <fieldset class="form-section orange">
                <legend>Assignment</legend>
                <div class="form-group">
                  <label for="edit-collectorId">Assign a Collector (and their Vehicle)</label>
                  <select id="edit-collectorId" formControlName="collectorId">
                    <option [ngValue]="null">-- Not Assigned --</option>
                    @for(collector of availableCollectors(); track collector.collectorId) {
                      <option [value]="collector.collectorId">
                        {{ collector.name }} (Vehicle: {{ collector.vehicleLicensePlate || 'N/A' }})
                      </option>
                    }
                  </select>
                </div>
              </fieldset>
              <fieldset class="form-section orange">
                <legend>Grower Locations (Waypoints)</legend>
                <div formArrayName="growerLocations" class="grower-list-editable">
                  @for (locationGroup of growerLocations.controls; track $index) {
                    <div [formGroupName]="$index" class="grower-item-editable">
                      <input formControlName="description" placeholder="Enter grower location name or address" />
                      <button type="button" (click)="removeGrowerLocation($index)" class="btn-remove" title="Remove Location">X</button>
                    </div>
                  }
                </div>
                <button type="button" (click)="addGrowerLocation()" class="btn-add-location">+ Add Waypoint</button>
              </fieldset>
              <div class="form-actions actionbar">
                <button type="button" class="btn-secondary" (click)="onCancel()">Cancel</button>
                <button type="submit" class="btn-primary" [disabled]="routeForm.invalid">Save Changes</button>
              </div>
            </form>
          </div>
        </div>
      }
    </div>
  </div>
</div>