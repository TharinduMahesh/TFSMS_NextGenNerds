<!-- ================================================== -->
<!-- Filename: r-edit.component.html (Corrected Modal) -->
<!-- ================================================== -->
<div class="modal-overlay" (click)="onCancel()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <button (click)="onCancel()" class="close-btn" title="Close">√ó</button>
    <h2 class="modal-title">Edit Route</h2>

    <div class="modal-body">
      @if (isLoading()) {
        <div class="loading">Loading route data...</div>
      } @else if (error()) {
        <div class="error-message">{{ error() }}</div>
      } @else {
        <!-- Main content section with the same layout as r-create -->
        <div class="r-create-flex">
          <div class="r-create-map">
            <app-google-map
              [startLocation]="routeForm.get('startLocation.address')?.value"
              [endLocation]="routeForm.get('endLocation.address')?.value"
              (startLocationSelected)="onStartLocationSelected($event)"
              (endLocationSelected)="onEndLocationSelected($event)"
              (routeInfoUpdated)="onRouteInfoUpdated($event)"
              (selectionStateChanged)="onMapStateChanged($event)">
            </app-google-map>
          </div>

          <div class="r-create-form">
            <form [formGroup]="routeForm" (ngSubmit)="onSubmit()" class="route-form">
              <div class="form-container">
                <div class="form-group">
                  <label for="edit-rName">Route Name</label>
                  <input id="edit-rName" type="text" formControlName="rName" placeholder="e.g., Kandy City Morning Run">
                  @if (routeForm.get('rName')?.invalid && routeForm.get('rName')?.touched) {
                    <span class="error-message">Route name is required.</span>
                  }
                </div>

                <div class="direction-controls">
                  @if (mapSelectionState() === MapSelectionState.IDLE) {
                    <button type="button" class="btn-primary" (click)="handleDirectionButtonClick()">
                      üìç Change Route from Map
                    </button>
                  } @else {
                    <button type="button" class="btn-secondary" (click)="handleDirectionButtonClick()">
                      Clear Route & Start Over
                    </button>
                  }
                </div>

                <div class="form-row">
                  <div class="form-group" formGroupName="startLocation">
                    <label for="edit-startLocation">Start Location</label>
                    <input #startLocationInput id="edit-startLocation" type="text" formControlName="address" placeholder="Search or use button above">
                    @if (routeForm.get('startLocation.address')?.invalid && routeForm.get('startLocation.address')?.touched) {
                      <span class="error-message">Start location is required.</span>
                    }
                  </div>

                  <div class="form-group" formGroupName="endLocation">
                    <label for="edit-endLocation">End Location</label>
                    <input #endLocationInput id="edit-endLocation" type="text" formControlName="address" placeholder="Search or select on map">
                    @if (routeForm.get('endLocation.address')?.invalid && routeForm.get('endLocation.address')?.touched) {
                      <span class="error-message">End location is required.</span>
                    }
                  </div>
                </div>

                <div class="form-group">
                  <label for="edit-distance">Route Distance (km)</label>
                  <input id="edit-distance" type="number" formControlName="distance" placeholder="Auto-calculated" readonly>
                  @if (estimatedDuration()) {
                    <small class="info-text">Estimated travel time: {{ estimatedDuration() }}</small>
                  }
                </div>

                <!-- Collector assignment with loading state -->
                <div class="form-group">
                  <label for="edit-collectorId">Assign Collector</label>
                  @if(isCollectorLoading()) {
                    <p class="loading-text">Loading collectors...</p>
                  } @else {
                    <select id="edit-collectorId" formControlName="collectorId">
                      <option [ngValue]="null">-- Not Assigned --</option>
                      @for(collector of availableCollectors(); track collector.collectorId) {
                        <option [value]="collector.collectorId">
                          {{ collector.name }} ({{ collector.vehicleLicensePlate || 'No Vehicle' }})
                        </option>
                      }
                    </select>
                    @if (routeForm.get('collectorId')?.invalid && routeForm.get('collectorId')?.touched) {
                      <span class="error-message">Please select a collector.</span>
                    }
                  }
                </div>
              </div>
            </form>
          </div>
        </div>
      }
    </div>

    <div class="form-actions">
      <button type="button" class="btn-secondary" (click)="onCancel()">Cancel</button>
      <!-- Button is disabled if the form is invalid OR if no changes have been made -->
      <button type="button" class="btn-primary" [disabled]="routeForm.invalid || !routeForm.dirty" (click)="onSubmit()">
        Save Changes
      </button>
    </div>
  </div>
</div>